{% extends "base.html" %}
{% block title %}Bilet Talebi Olu≈ütur{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
  <!-- Ba≈ülƒ±k -->
  <div class="mb-6">
    <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-primary-700">
      üé´ Bilet Talebi Olu≈ütur
    </h1>
    <p class="text-sm text-gray-600 mt-1">
      Bilgilerinizi eksiksiz doldurun. Talebiniz i√ßin bir <b>takip kodu</b> olu≈üturulacaktƒ±r.
    </p>
  </div>

  <!-- Kart -->
  <div class="bg-white/90 backdrop-blur rounded-2xl shadow-xl border border-gray-200 p-6 md:p-8 animate-fadeIn">
    <form method="post" class="grid grid-cols-1 md:grid-cols-2 gap-6" id="reqForm">
      {% csrf_token %}
      {{ form.non_field_errors }}

      <!-- Trip type (box i√ßinde) -->
      <div class="md:col-span-2">
        <div id="tripTypeBox" class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
          <div class="text-sm font-semibold text-gray-700 mb-2">Seyahat Tipi</div>
          <div class="flex items-center gap-8">
            {{ form.trip_type }}
          </div>
          <p class="text-xs text-gray-500 mt-2">
            ‚ÄúGidi≈ü-D√∂n√º≈ü‚Äù se√ßerseniz d√∂n√º≈ü alanlarƒ± otomatik a√ßƒ±lƒ±r.
          </p>
        </div>
      </div>

      <!-- Kullanƒ±cƒ± t√ºr√º -->
      <div class="flex flex-col">
        <label for="{{ form.user_type.id_for_label }}" class="form-label">Kullanƒ±cƒ± T√ºr√º</label>
        {{ form.user_type }}
        {% if form.user_type.errors %}<p class="form-error">{{ form.user_type.errors|join:", " }}</p>{% endif %}
      </div>

      <!-- Ula≈üƒ±m t√ºr√º -->
      <div class="flex flex-col">
        <label for="{{ form.transport.id_for_label }}" class="form-label">Ula≈üƒ±m T√ºr√º</label>
        {{ form.transport }}
        {% if form.transport.errors %}<p class="form-error">{{ form.transport.errors|join:", " }}</p>{% endif %}
      </div>

      <!-- Ad Soyad -->
      <div class="flex flex-col">
        <label for="{{ form.full_name.id_for_label }}" class="form-label">Ad Soyad</label>
        {{ form.full_name }}
        {% if form.full_name.errors %}<p class="form-error">{{ form.full_name.errors|join:", " }}</p>{% endif %}
      </div>

      <!-- E-posta -->
      <div class="flex flex-col">
        <label for="{{ form.email.id_for_label }}" class="form-label">E-posta</label>
        {{ form.email }}
        {% if form.email.errors %}<p class="form-error">{{ form.email.errors|join:", " }}</p>{% endif %}
      </div>

      <!-- Doƒüum tarihi -->
      <div class="flex flex-col">
        <label for="{{ form.birth_date.id_for_label }}" class="form-label">Doƒüum Tarihi</label>
        {{ form.birth_date }}
        {% if form.birth_date.errors %}<p class="form-error">{{ form.birth_date.errors|join:", " }}</p>{% endif %}
      </div>

      <!-- T.C. -->
      <div class="flex flex-col">
        <label for="{{ form.tc_no.id_for_label }}" class="form-label">T.C. Kimlik No</label>
        {{ form.tc_no }}
        {% if form.tc_no.errors %}<p class="form-error">{{ form.tc_no.errors|join:", " }}</p>{% endif %}
      </div>

      <!-- Telefon -->
      <div class="flex flex-col">
        <label for="{{ form.phone.id_for_label }}" class="form-label">Telefon</label>
        {{ form.phone }}
        {% if form.phone.errors %}<p class="form-error">{{ form.phone.errors|join:", " }}</p>{% endif %}
      </div>

      <!-- Nereden -->
      <div class="flex flex-col">
        <label for="{{ form.origin.id_for_label }}" class="form-label">Nereden</label>
        {{ form.origin }}
        {% if form.origin.errors %}<p class="form-error">{{ form.origin.errors|join:", " }}</p>{% endif %}
      </div>

      <!-- Nereye -->
      <div class="flex flex-col">
        <label for="{{ form.destination.id_for_label }}" class="form-label">Nereye</label>
        {{ form.destination }}
        {% if form.destination.errors %}<p class="form-error">{{ form.destination.errors|join:", " }}</p>{% endif %}
      </div>

      <!-- Gidi≈ü Tarihi -->
      <div class="flex flex-col">
        <label for="{{ form.travel_date.id_for_label }}" class="form-label">Gidi≈ü Tarihi</label>
        {{ form.travel_date }}
        {% if form.travel_date.errors %}<p class="form-error">{{ form.travel_date.errors|join:", " }}</p>{% endif %}
      </div>

      <!-- Gidi≈ü Saati (opsiyonel) -->
      <div class="flex flex-col">
        <label for="{{ form.departure_time.id_for_label }}" class="form-label">Gidi≈ü Saati (opsiyonel)</label>
        {{ form.departure_time }}
        {% if form.departure_time.errors %}<p class="form-error">{{ form.departure_time.errors|join:", " }}</p>{% endif %}
      </div>

      <!-- U√ßu≈ü numarasƒ± (yalnƒ±z u√ßak) -->
      <div class="flex flex-col hidden" id="planeExtras">
        <label for="{{ form.flight_number.id_for_label }}" class="form-label">U√ßu≈ü Numarasƒ± (opsiyonel)</label>
        {{ form.flight_number }}
        {% if form.flight_number.errors %}<p class="form-error">{{ form.flight_number.errors|join:", " }}</p>{% endif %}
      </div>

      <!-- Havayolu tercihi (yalnƒ±z u√ßak) -->
      <div class="flex flex-col hidden" id="airlineBox">
        <label for="{{ form.preferred_airline.id_for_label }}" class="form-label">Tercih Edilen Havayolu (opsiyonel)</label>
        {{ form.preferred_airline }}
        {% if form.preferred_airline.errors %}<p class="form-error">{{ form.preferred_airline.errors|join:", " }}</p>{% endif %}
      </div>

      <!-- D√∂n√º≈ü alanlarƒ± (roundtrip iken a√ßƒ±lƒ±r) -->
      <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6 hidden" id="returnGroup">
        <div class="flex flex-col">
          <label for="{{ form.return_destination.id_for_label }}" class="form-label">D√∂n√º≈ü Yeri</label>
          {{ form.return_destination }}
          {% if form.return_destination.errors %}<p class="form-error">{{ form.return_destination.errors|join:", " }}</p>{% endif %}
        </div>

        <div class="flex flex-col">
          <label for="{{ form.return_date.id_for_label }}" class="form-label">D√∂n√º≈ü Tarihi</label>
          {{ form.return_date }}
          {% if form.return_date.errors %}<p class="form-error">{{ form.return_date.errors|join:", " }}</p>{% endif %}
        </div>

        <div class="flex flex-col">
          <label for="{{ form.return_time.id_for_label }}" class="form-label">D√∂n√º≈ü Saati</label>
          {{ form.return_time }}
          {% if form.return_time.errors %}<p class="form-error">{{ form.return_time.errors|join:", " }}</p>{% endif %}
        </div>
      </div>

      <!-- Talep Nedeni -->
      <div class="flex flex-col">
        <label for="{{ form.reason.id_for_label }}" class="form-label">Seyahat Talep Nedeni</label>
        {{ form.reason }}
        {% if form.reason.errors %}<p class="form-error">{{ form.reason.errors|join:", " }}</p>{% endif %}
      </div>

      <!-- Diƒüer A√ßƒ±klama (yalnƒ±z ‚Äúdiger‚Äù iken) -->
      <div class="md:col-span-2 flex flex-col hidden" id="otherReasonBox">
        <label for="{{ form.reason_other.id_for_label }}" class="form-label">Diƒüer A√ßƒ±klama</label>
        {{ form.reason_other }}
        {% if form.reason_other.errors %}<p class="form-error">{{ form.reason_other.errors|join:", " }}</p>{% endif %}
      </div>

      <!-- Notlar -->
      <div class="md:col-span-2 flex flex-col">
        <label for="{{ form.notes.id_for_label }}" class="form-label">Notlar</label>
        {{ form.notes }}
        {% if form.notes.errors %}<p class="form-error">{{ form.notes.errors|join:", " }}</p>{% endif %}
      </div>

      <!-- G√∂nder -->
      <div class="md:col-span-2 flex justify-end gap-3">
        <a href="/" class="btn-secondary">ƒ∞ptal</a>
        <button type="submit" class="btn-primary">Talep Olu≈ütur</button>
      </div>
    </form>
  </div>
</div>

{% if tracking_code %}
  <!-- Takip kodu modal (kutunun tamamƒ± kopyalar) -->
  <div id="trackingModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 animate-pop">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
      <h2 class="text-2xl font-bold text-green-600 mb-3">‚úÖ Talep Alƒ±ndƒ±</h2>
      <p class="text-gray-700 mb-2">Takip Kodunuz:</p>

      <button type="button" onclick="copyCode(this)" class="w-full text-left group">
        <div class="flex items-center justify-between bg-gray-100 hover:bg-gray-200 border rounded-xl px-4 py-3 transition shadow-sm">
          <code id="trackingCode" class="font-mono text-lg text-gray-800">{{ tracking_code }}</code>
          <span class="ml-3 inline-flex items-center px-3 py-1.5 rounded-lg bg-blue-600 text-white text-sm
                       group-hover:bg-blue-700 transition" data-role="copy-badge">
            Kopyala
          </span>
        </div>
      </button>
      <p class="text-xs text-gray-500 mt-3">
        Kutunun herhangi bir yerine tƒ±klayarak kopyalayabilirsiniz.
      </p>

      <p class="text-sm text-gray-700 mb-6">
        ‚ö†Ô∏è <b>√ñnemli:</b> Bu kodla talebinizin durumunu g√∂r√ºnt√ºlersiniz. L√ºtfen <b>kopyalayƒ±n</b> ve <b>kaydedin</b>.
      </p>

      <div class="flex items-center justify-center gap-2">
        <a href="{% url 'tickets:status_detail' tracking_code=tracking_code %}"
           class="px-4 py-2.5 rounded-lg bg-primary-600 text-white font-semibold hover:bg-primary-700 transition">
          Durumu G√∂r√ºnt√ºle
        </a>
        <button type="button" onclick="closeModal()" 
          class="px-4 py-2.5 rounded-lg bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200 transition">
          Tamam
        </button>
      </div>
    </div>
  </div>
{% endif %}

<!-- Stil -->
<style>
  @keyframes fadeIn { from { opacity: 0; transform: translateY(12px);} to { opacity: 1; transform: translateY(0);} }
  .animate-fadeIn { animation: fadeIn 420ms ease-out; }
  @keyframes pop { from { opacity: 0; transform: scale(0.96);} to { opacity: 1; transform: scale(1);} }
  .animate-pop { animation: pop .22s ease-out; }

  :root{
    --primary-600:#1e88e5;
    --primary-700:#1565c0;
  }
  .text-primary-700{ color: var(--primary-700); }

  .form-label { font-size: .9rem; font-weight: 600; color: #374151; margin-bottom: .35rem; }
  input, select, textarea {
    border: 1px solid #d1d5db; border-radius: .65rem; padding: .6rem .8rem; background: #fff;
    outline: none; transition: border-color .2s, box-shadow .2s, transform .08s; font-size: .95rem;
  }
  input:hover, select:hover, textarea:hover { border-color: #c5c9d3; }
  input:focus, select:focus, textarea:focus { border-color: var(--primary-600); box-shadow: 0 0 0 4px rgba(30,136,229,.18); }
  .form-error { margin-top: .35rem; font-size: .78rem; color: #dc2626; }

  .btn-primary{
    display:inline-flex;align-items:center;justify-content:center;gap:.5rem;
    padding:.75rem 1.25rem;font-weight:700;color:#fff;border-radius:.75rem;
    background:var(--primary-600);
    box-shadow:0 8px 18px rgba(21,101,192,.22);
    transition:transform .15s ease, box-shadow .2s ease, filter .2s ease, background .2s;
  }
  .btn-primary:hover{ background:var(--primary-700); transform: translateY(-1px) scale(1.02); }
  .btn-primary:active{ transform:translateY(0) scale(.99); }

  .btn-secondary{
    display:inline-flex;align-items:center;justify-content:center;
    padding:.75rem 1.1rem;font-weight:600;color:#374151;
    background:#f3f4f6;border:1px solid #e5e7eb;border-radius:.75rem;
    transition:background .2s,color .2s,border-color .2s;
  }
  .btn-secondary:hover{ background:#eef0f4;border-color:#e5e7eb; }
</style>

<!-- JS -->
<script>
  (function () {
    // --- Elemanlar
    const transport = document.getElementById("{{ form.transport.id_for_label }}") ||
      document.querySelector('[name="{{ form.transport.html_name }}"]');
    const airlineBox = document.getElementById("airlineBox");
    const planeExtras = document.getElementById("planeExtras");

    const reason = document.getElementById("{{ form.reason.id_for_label }}") ||
      document.querySelector('[name="{{ form.reason.html_name }}"]');
    const otherBox = document.getElementById("otherReasonBox");

    const tripRadios = document.querySelectorAll('input[name="{{ form.trip_type.html_name }}"]');
    const returnGroup = document.getElementById("returnGroup");

    // --- Fonksiyonlar
    function toggleTrip() {
      let isRound = false;
      tripRadios.forEach(r => { if (r.checked && r.value === 'roundtrip') isRound = true; });
      returnGroup.classList.toggle('hidden', !isRound);
    }

    function togglePlaneParts() {
      const isPlane = transport && transport.value === 'plane';
      airlineBox.classList.toggle('hidden', !isPlane);
      planeExtras.classList.toggle('hidden', !isPlane);
      if (!isPlane) {
        const sel = airlineBox.querySelector('select'); if (sel) sel.value = "";
        const fn = planeExtras.querySelector('input'); if (fn) fn.value = "";
      }
    }

    function toggleOther() {
      if (!reason) return;
      otherBox.classList.toggle('hidden', reason.value !== 'diger');
    }

    // Min tarih: bug√ºn
    const today = new Date().toISOString().split('T')[0];
    const start = document.getElementById("{{ form.travel_date.id_for_label }}") ||
      document.querySelector('[name="{{ form.travel_date.html_name }}"]');
    if (start) start.setAttribute('min', today);
    const ret = document.getElementById("{{ form.return_date.id_for_label }}") ||
      document.querySelector('[name="{{ form.return_date.html_name }}"]');
    if (ret) ret.setAttribute('min', today);

    // TC input HTML kƒ±sƒ±tƒ±
    const tc = document.getElementById("{{ form.tc_no.id_for_label }}") ||
      document.querySelector('[name="{{ form.tc_no.html_name }}"]');
    if (tc) { tc.setAttribute('pattern','\\d{11}'); tc.setAttribute('maxlength','11'); tc.setAttribute('inputmode','numeric'); }

    // Telefon maskesi (xxx-xxx-xx-xx)
    const phone = document.getElementById("{{ form.phone.id_for_label }}") ||
      document.querySelector('[name="{{ form.phone.html_name }}"]');
    function maskPhone(e){
      let v = (e.target.value || "").replace(/\D/g,'').slice(0,10);
      const parts = [];
      if (v.length > 0) parts.push(v.substring(0,3));
      if (v.length > 3) parts.push(v.substring(3,6));
      if (v.length > 6) parts.push(v.substring(6,8));
      if (v.length > 8) parts.push(v.substring(8,10));
      e.target.value = parts.join('-');
    }
    if (phone){ phone.addEventListener('input', maskPhone); maskPhone({target: phone}); }

    // ƒ∞lk y√ºkleme + olaylar
    toggleTrip(); togglePlaneParts(); toggleOther();
    tripRadios.forEach(r => r.addEventListener('change', toggleTrip));
    if (transport) transport.addEventListener('change', togglePlaneParts);
    if (reason) reason.addEventListener('change', toggleOther);
  })();

  // G√ºvenli kopyalama + g√∂rsel geri bildirim
  function copyCode(btnEl) {
    const text = document.getElementById("trackingCode")?.textContent?.trim();
    if(!text) return;

    const done = () => {
      const badge = btnEl?.querySelector('[data-role="copy-badge"]');
      if (badge) {
        const orig = badge.textContent;
        badge.textContent = 'Kopyalandƒ± ‚úì';
        badge.classList.add('animate-pulse');
        setTimeout(() => {
          badge.textContent = orig;
          badge.classList.remove('animate-pulse');
        }, 1500);
      } else {
        alert("Takip kodu kopyalandƒ±: " + text);
      }
    };

    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(text).then(done).catch(() => fallbackCopy(text, done));
    } else {
      fallbackCopy(text, done);
    }
  }

  function fallbackCopy(text, done){
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    document.body.appendChild(ta);
    ta.select();
    try { document.execCommand('copy'); } catch(e) {}
    document.body.removeChild(ta);
    done && done();
  }

  function closeModal() {
    const modal = document.getElementById("trackingModal");
    if (modal) modal.remove();
  }
</script>
{% endblock %}
