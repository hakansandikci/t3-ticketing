{% extends "base.html" %}
{% block content %}
<div class="flex items-center justify-between mb-6">
  <h1 class="text-3xl font-extrabold bg-gradient-to-r from-red-600 via-orange-500 to-yellow-400 bg-clip-text text-transparent">
    👨‍💻 Personel Paneli
  </h1>
  <div class="space-x-2">
    <a class="px-3 py-2 rounded-lg bg-green-600 text-white text-sm shadow hover:scale-105 transition" href="{% url 'tickets:export_csv' %}">CSV</a>
    <a class="px-3 py-2 rounded-lg bg-green-600 text-white text-sm shadow hover:scale-105 transition" href="{% url 'tickets:export_xlsx' %}">XLSX</a>
    <a class="px-3 py-2 rounded-lg bg-orange-500 text-white text-sm shadow hover:scale-105 transition" href="{% url 'tickets:reports' %}">Raporlar</a>
    <form method="post" action="{% url 'logout' %}" class="inline">
      {% csrf_token %}
      <button type="submit" class="px-3 py-2 rounded-lg bg-red-600 text-white text-sm shadow hover:scale-105 transition">
        Çıkış
      </button>
    </form>
  </div>
</div>

<!-- Filtre Formu -->
<form method="get" class="bg-white/95 backdrop-blur p-4 rounded-2xl shadow mb-6 grid md:grid-cols-6 gap-3">
  <select name="status" class="form-select">
    <option value="">Durum (tümü)</option>
    <option value="pending"  {% if request.GET.status == "pending" %}selected{% endif %}>Beklemede</option>
    <option value="ticketed" {% if request.GET.status == "ticketed" %}selected{% endif %}>Bilet Alındı</option>
    <option value="rejected" {% if request.GET.status == "rejected" %}selected{% endif %}>Bilet Reddedildi</option>
  </select>

  <select name="transport" class="form-select">
    <option value="">Ulaşım (tümü)</option>
    <option value="bus"   {% if request.GET.transport == "bus" %}selected{% endif %}>Otobüs</option>
    <option value="plane" {% if request.GET.transport == "plane" %}selected{% endif %}>Uçak</option>
  </select>

  <select name="user_type" class="form-select">
    <option value="">Tür (tümü)</option>
    <option value="volunteer" {% if request.GET.user_type == "volunteer" %}selected{% endif %}>Gönüllü</option>
    <option value="scholar"   {% if request.GET.user_type == "scholar" %}selected{% endif %}>Bursiyer</option>
    <option value="staff"     {% if request.GET.user_type == "staff" %}selected{% endif %}>Personel</option>
  </select>

  <label class="inline-flex items-center gap-2 px-2">
    <input type="checkbox" name="has_changes" value="1"
           {% if request.GET.has_changes == "1" %}checked{% endif %}
           class="w-4 h-4 rounded border-gray-300">
    <span class="text-sm text-gray-700">Sadece değişiklik talebi olanlar</span>
  </label>

  <!-- Opsiyonel arama -->
  <input type="text" name="q" value="{{ request.GET.q }}" placeholder="Ad / Takip / PNR ara (opsiyonel)" class="form-input md:col-span-2">

  <!-- Butonlar (sola hizalı) -->
  <div class="flex items-center gap-2 md:col-span-6">
    <button class="px-4 py-2 rounded-lg bg-gradient-to-r from-red-600 via-orange-500 to-yellow-400 text-white font-medium shadow hover:scale-105 transition">
      Filtrele
    </button>
    <a href="{% url 'tickets:staff_dashboard' %}"
       class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium shadow hover:bg-gray-300 transition">
      Tümünü Temizle
    </a>
  </div>
</form>

<!-- Tablo -->
<div class="bg-white rounded-2xl shadow overflow-x-auto">
  <table class="min-w-full text-sm">
    <thead class="bg-gradient-to-r from-red-600 via-orange-500 to-yellow-400 text-white">
      <tr>
        <th class="text-left p-3">Kullanıcı</th>
        <th class="text-left p-3">Takip</th>
        <th class="text-left p-3">Ad Soyad</th>
        <th class="text-left p-3">Tür</th>
        <th class="text-left p-3">Rota</th>
        <th class="text-left p-3">Tarih</th>
        <th class="text-left p-3">Ulaşım</th>
        <th class="text-left p-3">Durum</th>
        <th class="text-left p-3">PNR</th>
        <th class="text-left p-3">Değişiklik</th>
        <th class="text-left p-3">İşlem</th>
      </tr>
    </thead>
    <tbody>
      {% for t in tickets %}
      <tr class="border-b hover:bg-orange-50 transition">
        <!-- Kullanıcı (purchased_by) -->
        <td class="p-3">
          {% if t.purchased_by %}
            <div class="flex items-center gap-2">
              <div class="w-7 h-7 rounded-full bg-orange-100 text-orange-700 flex items-center justify-center text-xs font-semibold">
                {% firstof t.purchased_by.first_name|slice:":1" t.purchased_by.username|slice:":1" %}{% if t.purchased_by.last_name %}{{ t.purchased_by.last_name|slice:":1" }}{% endif %}
              </div>
              <div class="leading-tight">
                <div class="font-medium">
                  {% firstof t.purchased_by.get_full_name t.purchased_by.username %}
                </div>
                <div class="text-[11px] text-gray-500">
                  {% if t.purchased_by.email %}{{ t.purchased_by.email }}{% endif %}
                </div>
              </div>
            </div>
          {% else %}
            <span class="text-xs text-gray-400">—</span>
          {% endif %}
        </td>

        <td class="p-3">
          {% if t.status == "rejected" %}
            <span class="inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full bg-red-100 text-red-700 border border-red-200">
              Reddedildi
            </span>
            {% if t.rejected_by %}
              <div class="text-[11px] text-gray-600 mt-1">
                {% firstof t.rejected_by.get_full_name t.rejected_by.username %}
              </div>
            {% endif %}
          {% elif t.status == "ticketed" %}
            <span class="inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full bg-green-100 text-green-800 border border-green-200">
              Bilet Alındı
            </span>
          {% else %}
            <span class="inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full bg-gray-100 text-gray-700 border border-gray-200">
              Beklemede
            </span>
          {% endif %}
        </td>

        <td class="p-3 font-mono">{{ t.tracking_code }}</td>
        <td class="p-3">{{ t.full_name }}</td>
        <td class="p-3">{{ t.get_user_type_display }}</td>
        <td class="p-3">{{ t.origin }} → {{ t.destination }}</td>
        <td class="p-3">{{ t.travel_date }}</td>
        <td class="p-3">{{ t.get_transport_display }}</td>
        <td class="p-3">
          {% if t.status == "pending" %}
            <span class="inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full bg-gray-100 text-gray-700 border border-gray-200">Beklemede</span>
          {% elif t.status == "ticketed" %}
            <span class="inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full bg-green-100 text-green-800 border border-green-200">Bilet Alındı</span>
          {% elif t.status == "rejected" %}
            <span class="inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full bg-red-100 text-red-700 border border-red-200">Bilet Reddedildi</span>
          {% endif %}
        </td>
        <td class="p-3">{{ t.pnr_code|default:"-" }}</td>

        <td class="p-3">
          {% with c=t.change_count|default:0 %}
            {% if c|add:0 > 0 %}
              <button type="button"
                      class="inline-flex items-center px-2 py-0.5 text-xs font-semibold rounded-full bg-amber-100 text-amber-800 hover:brightness-95 transition"
                      data-changes-target="changes-{{ t.id }}">
                {{ c }} talep • Gör
              </button>
            {% else %}
              <span class="text-xs text-gray-400">—</span>
            {% endif %}
          {% endwith %}
        </td>

        <td class="p-3">
          <a class="px-3 py-1.5 rounded bg-indigo-600 text-white text-xs shadow hover:bg-indigo-700 transition"
             href="{% url 'tickets:staff_ticket_edit' t.id %}">Düzenle</a>
        </td>
      </tr>

      <!-- Gizli değişiklik listesi -->
      <div id="changes-{{ t.id }}" class="hidden">
        <div class="space-y-3 text-left">
          {% for ch in t.changes.all %}
            <div class="p-3 rounded-lg border bg-gray-50">
              <div class="text-xs text-gray-500 mb-1">
                {{ ch.created_at|date:"d.m.Y H:i" }}
              </div>
              <div class="text-sm text-gray-800 whitespace-pre-wrap">
                {{ ch.reason }}
              </div>
            </div>
          {% empty %}
            <div class="text-sm text-gray-500">Değişiklik talebi bulunmuyor.</div>
          {% endfor %}
        </div>
      </div>
      {% empty %}
      <tr><td class="p-4 text-center text-gray-500" colspan="11">Kayıt yok</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal -->
<div id="changesModal" class="hidden fixed inset-0 z-50">
  <div class="absolute inset-0 bg-black/60"></div>
  <div class="relative z-10 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-6 animate-pop">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-800">Değişiklik Talepleri</h3>
        <button type="button" class="text-gray-500 hover:text-gray-700" onclick="closeChangesModal()">✕</button>
      </div>
      <div id="changesBody" class="max-h-[60vh] overflow-auto pr-1"></div>
      <div class="mt-6 text-right">
        <button type="button"
                class="px-4 py-2 rounded-lg bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200 transition"
                onclick="closeChangesModal()">
          Kapat
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Özel stiller -->
<style>
  .form-select, .form-input {
    border: 1px solid #d1d5db;
    border-radius: 0.65rem;
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
    transition: border-color 0.2s, box-shadow 0.2s;
    background: #fff;
  }
  .form-select:focus, .form-input:focus {
    border-color: #f97316;
    box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.25);
    outline: none;
  }
  @keyframes pop { from {opacity:0; transform:scale(.97);} to {opacity:1; transform:scale(1);} }
  .animate-pop { animation: pop .18s ease-out; }
</style>

<!-- JS: rozet tıkla → modal aç -->
<script>
  document.addEventListener('click', function(e){
    const btn = e.target.closest('[data-changes-target]');
    if(!btn) return;
    const targetId = btn.getAttribute('data-changes-target');
    const source = document.getElementById(targetId);
    if(!source) return;
    document.getElementById('changesBody').innerHTML = source.innerHTML;
    document.getElementById('changesModal').classList.remove('hidden');
  });
  function closeChangesModal(){
    document.getElementById('changesModal').classList.add('hidden');
    document.getElementById('changesBody').innerHTML = '';
  }
</script>
{% endblock %}
